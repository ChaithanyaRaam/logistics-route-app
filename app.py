# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import numpy as np
import math
import io
import folium
from weasyprint import HTML

# --------------------------------------------------
# CONFIG
# --------------------------------------------------
st.set_page_config(
    page_title="Logistics Route Optimization",
    layout="wide"
)

# --------------------------------------------------
# UTILITY FUNCTIONS
# --------------------------------------------------
def get_distance(lat1, lon1, lat2, lon2):
    return np.sqrt((lat1 - lat2) ** 2 + (lon1 - lon2) ** 2)


# --------------------------------------------------
# CORE LOGIC
# --------------------------------------------------
def process_logistics(
    uploaded_file,
    available_bikers,
    capacity_per_biker,
    pickup_lat,
    pickup_lon,
    pickup_pincode
):
    # Load Excel
    df = pd.read_excel(uploaded_file)

    required_cols = {"Pincode", "Latitude", "Longitude", "Orders"}
    if not required_cols.issubset(df.columns):
        st.error(f"Excel must contain columns: {required_cols}")
        return pd.DataFrame()

    # Aggregate unique stops
    stops = (
        df.groupby(["Pincode", "Latitude", "Longitude"])["Orders"]
        .sum()
        .reset_index()
        .rename(columns={"Orders": "TotalOrders"})
    )

    stops["Area_Name"] = stops["Pincode"].astype(str)
    stops = stops.sort_values(["Pincode"]).reset_index(drop=True)

    # Assign bikers based on capacity
    assigned = []
    biker_id = 1
    capacity_used = 0

    for _, row in stops.iterrows():
        if capacity_used + row["TotalOrders"] > capacity_per_biker:
            biker_id += 1
            capacity_used = 0

        assigned.append({
            "Biker_ID": biker_id,
            "Pincode": row["Pincode"],
            "Area_Name": row["Area_Name"],
            "Latitude": row["Latitude"],
            "Longitude": row["Longitude"],
            "TotalOrders": row["TotalOrders"]
        })
        capacity_used += row["TotalOrders"]

    assigned_df = pd.DataFrame(assigned)

    # Route optimization (Nearest Neighbor)
    final_routes = []

    for biker in assigned_df["Biker_ID"].unique():
        group = assigned_df[assigned_df["Biker_ID"] == biker].to_dict("records")

        pickup = {
            "Biker_ID": biker,
            "Pincode": pickup_pincode,
            "Area_Name": "Pickup Location",
            "Latitude": pickup_lat,
            "Longitude": pickup_lon,
            "TotalOrders": 0
        }

        route = [pickup]
        current = pickup

        while group:
            nearest = min(
                group,
                key=lambda x: get_distance(
                    current["Latitude"], current["Longitude"],
                    x["Latitude"], x["Longitude"]
                )
            )
            route.append(nearest)
            group.remove(nearest)
            current = nearest

        for seq, stop in enumerate(route, start=1):
            stop["Sequence"] = seq
            final_routes.append(stop)

    final_df = pd.DataFrame(final_routes)

    # Summary
    total_orders = stops["TotalOrders"].sum()
    riders_required = math.ceil(total_orders / capacity_per_biker)

    st.markdown("### üìä Delivery Summary")
    st.write(f"**Total Orders:** {total_orders}")
    st.write(f"**Capacity / Rider:** {capacity_per_biker}")
    st.write(f"**Riders Required:** {riders_required}")
    st.write(f"**Riders Available:** {available_bikers}")

    if riders_required > available_bikers:
        st.warning(f"‚ö†Ô∏è Short by {riders_required - available_bikers} riders")
    else:
        st.success("‚úÖ Rider capacity sufficient")

    return final_df


# --------------------------------------------------
# MAP + PDF
# --------------------------------------------------
def generate_biker_map_html(df, biker_id):
    df = df.sort_values("Sequence")

    m = folium.Map(
        location=[df["Latitude"].mean(), df["Longitude"].mean()],
        zoom_start=12
    )

    for _, r in df.iterrows():
        color = "green" if "PICKUP" in str(r["Pincode"]) else "blue"
        folium.Marker(
            [r["Latitude"], r["Longitude"]],
            popup=f"""
            <b>{r['Pincode']}</b><br>
            Orders: {r['TotalOrders']}<br>
            Seq: {r['Sequence']}
            """,
            icon=folium.Icon(color=color)
        ).add_to(m)

    folium.PolyLine(
        df[["Latitude", "Longitude"]].values.tolist(),
        weight=4,
        color="red"
    ).add_to(m)

    return f"""
    <div style="page-break-after: always;">
        <h2>Biker {biker_id}</h2>
        {m._repr_html_()}
    </div>
    """


# --------------------------------------------------
# STREAMLIT UI
# --------------------------------------------------
st.title("üö¥ Logistics Route Optimization")

uploaded_file = st.file_uploader(
    "Upload Order Excel",
    type=["xlsx"]
)

st.subheader("Pickup Location")
pickup_pincode = st.text_input("Pickup Name", "PICKUP_CHENNAI")
pickup_lat = st.number_input("Latitude", value=13.0827, format="%.6f")
pickup_lon = st.number_input("Longitude", value=80.2707, format="%.6f")

st.subheader("Capacity Settings")
available_bikers = st.number_input("Available Bikers", 1, 100, 10)
capacity_per_biker = st.number_input("Orders per Biker", 1, 50, 10)

if st.button("Generate Routes"):
    if uploaded_file is None:
        st.warning("Please upload an Excel file")
    else:
        final_df = process_logistics(
            uploaded_file,
            available_bikers,
            capacity_per_biker,
            pickup_lat,
            pickup_lon,
            pickup_pincode
        )

        if not final_df.empty:
            st.subheader("üìã Trip Sheet")
            st.dataframe(final_df)

            # CSV
            st.download_button(
                "Download CSV",
                final_df.to_csv(index=False).encode("utf-8"),
                "biker_trip_sheet.csv",
                "text/csv"
            )

            # PDF
            html_blocks = []
            for biker in final_df["Biker_ID"].unique():
                html_blocks.append(
                    generate_biker_map_html(
                        final_df[final_df["Biker_ID"] == biker],
                        biker
                    )
                )

            full_html = f"""
            <html>
            <body>
            <h1>All Biker Routes</h1>
            {''.join(html_blocks)}
            </body>
            </html>
            """

            pdf_buffer = io.BytesIO()
            HTML(string=full_html).write_pdf(pdf_buffer)
            pdf_buffer.seek(0)

            st.download_button(
                "Download Routes PDF",
                pdf_buffer,
                "biker_routes.pdf",
                "application/pdf"
            )

