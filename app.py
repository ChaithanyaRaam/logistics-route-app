# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import math

# ==================================================
# PAGE CONFIG
# ==================================================
st.set_page_config(page_title="SKC Chennai Biker Routing", layout="wide")
st.title("ðŸšš SKC â€“ Chennai Biker Model Route Generator")

# ==================================================
# SESSION STATE (persist outputs)
# ==================================================
for k in ["WH1_A", "WH1_B", "WH2_A", "WH2_B"]:
    if k not in st.session_state:
        st.session_state[k] = None

# ==================================================
# WAREHOUSES
# ==================================================
WH1_LAT, WH1_LON = 12.98, 80.14
WH2_LAT, WH2_LON = 13.02, 80.15

# ==================================================
# ZONES
# ==================================================
WH1_ZONES = {"South / OMR / Tambaram", "Outer West / Peripheral"}
WH2_ZONES = {
    "North Chennai",
    "West/Inner West",
    "Central Chennai",
    "Velachery / Guindy / Saidapet"
}

WH1_ZONE_PRIORITY = ["South / OMR / Tambaram", "Outer West / Peripheral"]
WH2_ZONE_PRIORITY = [
    "Central Chennai",
    "Velachery / Guindy / Saidapet",
    "West/Inner West",
    "North Chennai"
]

# ==================================================
# PINCODE MASTER (UNCHANGED â€“ FULL LIST)
# ==================================================
PINCODE_MASTER = {
    "600004": (13.03822395, 80.27128091, "Central Chennai"),
    "600018": (13.03968161, 80.25069833, "Central Chennai"),
    "600020": (13.00861571, 80.26382063, "Central Chennai"),
    "600033": (13.03665727, 80.22349452, "West/Inner West"),
    "600037": (13.00314698, 80.19439843, "West/Inner West"),
    "600041": (12.92107178, 80.24654060, "Central Chennai"),
    "600042": (12.98731219, 80.21497575, "Velachery / Guindy / Saidapet"),
    "600044": (12.94443761, 80.08270867, "Central Chennai"),
    "600073": (12.87473594, 80.16536515, "West/Inner West"),
    "600075": (12.97247284, 80.14527780, "Velachery / Guindy / Saidapet"),
    "600078": (13.03888524, 80.19703562, "West/Inner West"),
    "600090": (13.00035027, 80.26501762, "West/Inner West"),
    "600095": (13.00159395, 80.07333575, "Outer West / Peripheral"),
    "600097": (13.02105769, 80.19311610, "South / OMR / Tambaram"),
    "600119": (12.84670995, 80.22056520, "South / OMR / Tambaram"),
    "600067": (13.24458812, 80.11956125, "Outer West / Peripheral"),
    "600103": (13.21852413, 80.28708594, "North Chennai"),
    "600057": (13.20823684, 80.31938310, "Outer West / Peripheral"),
    "600055": (13.15200630, 80.06539575, "Outer West / Peripheral"),
    "600066": (13.17287844, 80.14430264, "Outer West / Peripheral"),
    "600052": (13.18161067, 80.20075271, "Outer West / Peripheral"),
    "600019": (13.17301760, 80.29978173, "North Chennai"),
    "600068": (13.16732425, 80.27486313, "Outer West / Peripheral"),
    "600062": (13.14855215, 80.11554808, "Outer West / Peripheral"),
    "600051": (13.16442935, 80.24274514, "North Chennai"),
    "600060": (13.15984107, 80.21285943, "West/Inner West"),
    "600063": (13.14641833, 80.23279686, "West/Inner West"),
    "600081": (13.14166580, 80.27579586, "North Chennai"),
    "600065": (13.13664436, 80.07599155, "South / OMR / Tambaram"),
    "600118": (13.13085292, 80.25301868, "North Chennai"),
    "600099": (13.12735674, 80.20347764, "Outer West / Peripheral"),
    "600110": (13.13040427, 80.22737043, "North Chennai"),
    "600053": (13.12576836, 80.15617958, "North Chennai"),
    "600080": (13.11995567, 80.18563394, "North Chennai"),
    "600077": (13.09097107, 80.11778444, "Outer West / Peripheral"),
    "600039": (13.11713793, 80.26141064, "North Chennai"),
    "600001": (13.09329602, 80.29234733, "North Chennai"),
    "600054": (13.12153238, 80.08974434, "West/Inner West"),
    "600021": (13.11375956, 80.28122798, "North Chennai"),
    "600013": (13.11235222, 80.29319999, "North Chennai"),
    "600011": (13.11157220, 80.23642517, "North Chennai"),
    "600082": (13.11271678, 80.22637171, "North Chennai"),
    "600076": (13.10722147, 80.17469044, "West/Inner West"),
    "600049": (13.10809330, 80.20458989, "West/Inner West"),
    "600012": (13.10072145, 80.25438489, "North Chennai"),
    "600058": (13.08599979, 80.15314580, "West/Inner West"),
    "600071": (13.08290114, 80.13468571, "West/Inner West"),
    "600038": (13.09970732, 80.21607728, "Central Chennai"),
    "600079": (13.09873687, 80.27444704, "West/Inner West"),
    "600023": (13.09785468, 80.23194790, "Central Chennai"),
    "600040": (13.08791959, 80.20340556, "Central Chennai"),
    "600112": (13.09375497, 80.26446011, "North Chennai"),
    "600101": (13.09346695, 80.19369249, "North Chennai"),
    "600050": (13.07845424, 80.17154103, "West/Inner West"),
    "600072": (13.06843045, 80.03952992, "West/Inner West"),
    "600010": (13.08533821, 80.24161023, "Central Chennai"),
    "600009": (13.09230677, 80.27978745, "North Chennai"),
    "600102": (13.08901357, 80.22177351, "North Chennai"),
    "600003": (13.08615536, 80.27541704, "North Chennai"),
    "600108": (13.09004952, 80.28378675, "North Chennai"),
    "600104": (13.07738623, 80.28344719, "Outer West / Peripheral"),
    "600007": (13.08330279, 80.26371191, "North Chennai"),
    "600109": (13.08529100, 80.28188795, "North Chennai"),
    "600030": (13.07852208, 80.22433917, "North Chennai"),
    "600002": (13.07587854, 80.27184724, "North Chennai"),
    "600106": (13.07272018, 80.21201510, "Outer West / Peripheral"),
    "600008": (13.07072237, 80.26052995, "North Chennai"),
    "600084": (13.07673890, 80.25536237, "North Chennai"),
    "600031": (13.07382434, 80.24273335, "Central Chennai"),
    "600107": (13.06642121, 80.19938448, "Outer West / Peripheral"),
    "600029": (13.07112435, 80.22768880, "West/Inner West"),
    "600111": (13.05998516, 80.17606474, "North Chennai"),
    "600034": (13.06162757, 80.24200381, "Central Chennai"),
    "600005": (13.06115582, 80.27910272, "North Chennai"),
    "600105": (13.06556481, 80.26477927, "Outer West / Peripheral"),
    "600094": (13.05871690, 80.22123519, "West/Inner West"),
    "600026": (13.05464910, 80.21153926, "West/Inner West"),
    "600014": (13.05249900, 80.26461449, "Central Chennai"),
    "600006": (13.05816598, 80.25277144, "North Chennai"),
    "600092": (13.05479426, 80.19262737, "South / OMR / Tambaram"),
    "600116": (13.03950621, 80.14712513, "South / OMR / Tambaram"),
    "600024": (13.05095814, 80.22570484, "Central Chennai"),
    "600093": (13.04982278, 80.19958382, "South / OMR / Tambaram"),
    "600056": (13.03248812, 80.10160032, "Outer West / Peripheral"),
    "600087": (13.04286066, 80.17383656, "South / OMR / Tambaram"),
    "600017": (13.04185857, 80.23566124, "Velachery / Guindy / Saidapet"),
    "600015": (13.02147994, 80.22940007, "Velachery / Guindy / Saidapet"),
    "600028": (13.02418865, 80.26574570, "Central Chennai"),
    "600086": (13.01882901, 80.25013371, "South / OMR / Tambaram"),
    "600098": (13.01657599, 80.20718349, "Outer West / Peripheral"),
    "600032": (13.00634558, 80.21208726, "Velachery / Guindy / Saidapet"),
    "600061": (12.98350623, 80.18568904, "Velachery / Guindy / Saidapet"),
    "600113": (12.97360185, 80.23845300, "Velachery / Guindy / Saidapet"),
    "600091": (12.95940286, 80.19959318, "Velachery / Guindy / Saidapet"),
    "600117": (12.95986297, 80.17695456, "South / OMR / Tambaram"),
    "600100": (12.94342554, 80.18769461, "South / OMR / Tambaram"),
    "600064": (12.93264682, 80.14546711, "Velachery / Guindy / Saidapet"),
    "600045": (12.89426827, 80.10366229, "Velachery / Guindy / Saidapet"),
    "600048": (12.81084603, 80.12772838, "South / OMR / Tambaram"),
    "600069": (12.49833560, 79.97398277, "Outer West / Peripheral"),
}
# ==================================================
# GEO
# ==================================================
def haversine(lat1, lon1, lat2, lon2):
    R = 6371
    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)
    a = (
        math.sin(dlat / 2) ** 2 +
        math.cos(math.radians(lat1)) *
        math.cos(math.radians(lat2)) *
        math.sin(dlon / 2) ** 2
    )
    return 2 * R * math.asin(math.sqrt(a))

# ==================================================
# SOFT ZONE ROUTING (KEY FIX)
# ==================================================
def zone_priority_route(df, start_lat, start_lon, zone_priority):
    remaining = df.copy()
    route = []
    curr_lat, curr_lon = start_lat, start_lon

    for zone in zone_priority:
        zone_df = remaining[remaining["Zone"] == zone].copy()
        if zone_df.empty:
            continue

        # --------------------------------------------------
        # STEP 1: choose ENTRY point for the zone (single jump)
        # --------------------------------------------------
        zone_df["EntryDist"] = zone_df.apply(
            lambda x: haversine(curr_lat, curr_lon, x["Latitude"], x["Longitude"]),
            axis=1
        )
        entry = zone_df.sort_values("EntryDist").iloc[0]

        route.append(entry)
        curr_lat, curr_lon = entry["Latitude"], entry["Longitude"]

        remaining = remaining[remaining["Pincode"] != entry["Pincode"]]
        zone_df = remaining[remaining["Zone"] == zone].copy()

        # --------------------------------------------------
        # STEP 2: nearest-neighbour INSIDE the zone only
        # --------------------------------------------------
        while not zone_df.empty:
            zone_df["Dist"] = zone_df.apply(
                lambda x: haversine(curr_lat, curr_lon, x["Latitude"], x["Longitude"]),
                axis=1
            )
            nxt = zone_df.sort_values("Dist").iloc[0]

            route.append(nxt)
            curr_lat, curr_lon = nxt["Latitude"], nxt["Longitude"]

            remaining = remaining[remaining["Pincode"] != nxt["Pincode"]]
            zone_df = remaining[remaining["Zone"] == zone]

    return pd.DataFrame(route)
# ==================================================
# PLAN B â€“ BIKER ONLY (NO CAPACITY)
# ==================================================
def plan_b(df, lat, lon, bikers, zone_priority):
    ordered = zone_priority_route(df, lat, lon, zone_priority).reset_index(drop=True)
    chunk = math.ceil(len(ordered) / bikers)

    ordered["Biker_ID"] = (ordered.index // chunk) + 1
    ordered["Biker_ID"] = ordered["Biker_ID"].clip(upper=bikers)

    return ordered[["Pincode", "Orders", "Zone", "Biker_ID"]]

# ==================================================
# PLAN A â€“ CAPACITY AWARE
# ==================================================
def plan_a(df, lat, lon, bikers, max_cap, zone_priority):
    ordered = zone_priority_route(df, lat, lon, zone_priority)

    rows = []
    biker, load = 1, 0

    for _, r in ordered.iterrows():
        if load + r.Orders > max_cap:
            biker += 1
            load = 0
        rows.append({
            "Pincode": r.Pincode,
            "Orders": r.Orders,
            "Zone": r.Zone,
            "Biker_ID": biker
        })
        load += r.Orders

    return pd.DataFrame(rows)

# ==================================================
# SIDEBAR
# ==================================================
st.sidebar.header("Capacity & Riders")
max_cap = st.sidebar.number_input("Max orders per biker (Plan A)", 1, 200, 15)
total_bikers = st.sidebar.number_input("Total bikers (WH1 + WH2)", 1, 200, 6)
uploaded = st.sidebar.file_uploader("Upload Orders (Pincode, Orders)", type=["csv", "xlsx"])

# ==================================================
# MAIN RUN
# ==================================================
if st.button("Generate Routes") and uploaded:
    orders = pd.read_csv(uploaded) if uploaded.name.endswith(".csv") else pd.read_excel(uploaded)
    orders["Pincode"] = orders["Pincode"].astype(str)
    orders["Orders"] = orders["Orders"].astype(int)

    master = pd.DataFrame(
        [{"Pincode": k, "Latitude": v[0], "Longitude": v[1], "Zone": v[2]} for k, v in PINCODE_MASTER.items()]
    )

    base = orders.merge(master, on="Pincode", how="left")

    if base.Zone.isna().any():
        st.error(f"Unmapped pincodes: {base[base.Zone.isna()].Pincode.tolist()}")
        st.stop()

    wh1 = base[base.Zone.isin(WH1_ZONES)]
    wh2 = base[base.Zone.isin(WH2_ZONES)]

    wh1_bikers = max(1, round(total_bikers * len(wh1) / len(base)))
    wh2_bikers = max(1, total_bikers - wh1_bikers)

    st.session_state.WH1_A = plan_a(wh1, WH1_LAT, WH1_LON, wh1_bikers, max_cap, WH1_ZONE_PRIORITY)
    st.session_state.WH1_B = plan_b(wh1, WH1_LAT, WH1_LON, wh1_bikers, WH1_ZONE_PRIORITY)
    st.session_state.WH2_A = plan_a(wh2, WH2_LAT, WH2_LON, wh2_bikers, max_cap, WH2_ZONE_PRIORITY)
    st.session_state.WH2_B = plan_b(wh2, WH2_LAT, WH2_LON, wh2_bikers, WH2_ZONE_PRIORITY)

    st.success("Routes generated successfully")

# ==================================================
# DOWNLOADS
# ==================================================
st.subheader("â¬‡ Downloads")
if st.session_state.WH1_A is not None:
    st.download_button("WH1 Plan A", st.session_state.WH1_A.to_csv(index=False), "WH1_Plan_A.csv")
    st.download_button("WH1 Plan B", st.session_state.WH1_B.to_csv(index=False), "WH1_Plan_B.csv")
    st.download_button("WH2 Plan A", st.session_state.WH2_A.to_csv(index=False), "WH2_Plan_A.csv")
    st.download_button("WH2 Plan B", st.session_state.WH2_B.to_csv(index=False), "WH2_Plan_B.csv")

# ==================================================
# SUMMARY
# ==================================================
st.subheader("ðŸ“Š Warehouse Summary")

def show_summary(df, title):
    grp = df.groupby("Biker_ID")["Orders"].sum()
    st.markdown(f"**{title}**")
    st.dataframe(pd.DataFrame([{
        "Total Orders": grp.sum(),
        "Bikers Used": grp.count(),
        "Avg Orders / Biker": round(grp.mean(), 1),
        "Max Orders / Biker": grp.max(),
        "Min Orders / Biker": grp.min()
    }]))

if st.session_state.WH1_A is not None:
    show_summary(st.session_state.WH1_A, "WH1 â€“ Plan A")
    show_summary(st.session_state.WH1_B, "WH1 â€“ Plan B")
    show_summary(st.session_state.WH2_A, "WH2 â€“ Plan A")
    show_summary(st.session_state.WH2_B, "WH2 â€“ Plan B")

