# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import numpy as np
import math

# --------------------------------------------------
# PAGE CONFIG
# --------------------------------------------------
st.set_page_config(page_title="Multi-Warehouse Route Optimizer", layout="wide")

# --------------------------------------------------
# HELPERS
# --------------------------------------------------
def euclidean_distance(lat1, lon1, lat2, lon2):
    return math.sqrt((lat1 - lat2)**2 + (lon1 - lon2)**2)

def bearing(lat1, lon1, lat2, lon2):
    """Angle for sweep routing"""
    return math.atan2(lon2 - lon1, lat2 - lat1)

def build_routes_sweep(df, wh_lat, wh_lon, wh_name, plan_type):
    routes = []

    for biker in sorted(df["Biker_ID"].unique()):
        group = df[df["Biker_ID"] == biker].to_dict("records")

        pickup = {
            "Warehouse": wh_name,
            "Biker_ID": biker,
            "Pincode": wh_name,
            "Latitude": wh_lat,
            "Longitude": wh_lon,
            "TotalOrders": 0
        }

        # ---- SWEEP ROUTING ----
        group_sorted = sorted(
            group,
            key=lambda x: bearing(
                wh_lat, wh_lon,
                x["Latitude"], x["Longitude"]
            )
        )

        route = [pickup] + group_sorted

        for seq, stop in enumerate(route, start=1):
            stop["Sequence"] = seq
            stop["Plan_Type"] = plan_type
            routes.append(stop)

    return pd.DataFrame(routes)

# --------------------------------------------------
# PLAN A â€“ IDEAL CAPACITY BASED
# --------------------------------------------------
def plan_a(df, capacity_per_rider, wh_lat, wh_lon, wh_name):
    assigned = []
    biker = 1
    load = 0

    for _, r in df.iterrows():
        if load + r["TotalOrders"] > capacity_per_rider:
            biker += 1
            load = 0

        assigned.append({
            "Warehouse": wh_name,
            "Biker_ID": biker,
            "Pincode": r["Pincode"],
            "Latitude": r["Latitude"],
            "Longitude": r["Longitude"],
            "TotalOrders": r["TotalOrders"]
        })
        load += r["TotalOrders"]

    return build_routes_sweep(
        pd.DataFrame(assigned),
        wh_lat, wh_lon, wh_name,
        "Ideal Capacity Based"
    )

# --------------------------------------------------
# PLAN B â€“ RIDER CONSTRAINED
# --------------------------------------------------
def plan_b(df, riders, wh_lat, wh_lon, wh_name):
    assigned = []
    rider_cycle = list(range(1, riders + 1))
    idx = 0

    for _, r in df.iterrows():
        assigned.append({
            "Warehouse": wh_name,
            "Biker_ID": rider_cycle[idx],
            "Pincode": r["Pincode"],
            "Latitude": r["Latitude"],
            "Longitude": r["Longitude"],
            "TotalOrders": r["TotalOrders"]
        })
        idx = (idx + 1) % riders

    result = build_routes_sweep(
        pd.DataFrame(assigned),
        wh_lat, wh_lon, wh_name,
        "Rider Constrained"
    )

    load = (
        result[result["TotalOrders"] > 0]
        .groupby("Biker_ID")["TotalOrders"]
        .sum()
        .reset_index()
        .rename(columns={"TotalOrders": "Total_Load"})
    )

    return result.merge(load, on="Biker_ID", how="left")

# --------------------------------------------------
# STREAMLIT UI
# --------------------------------------------------
st.title("ðŸšš Multi-Warehouse Route Optimization (Sweep Routing)")

uploaded_file = st.file_uploader("Upload Orders Excel", type=["xlsx"])

# --------------------
# Warehouses
# --------------------
st.subheader("Warehouse 1 (Mandatory)")
wh1_name = st.text_input("WH1 Name", "WH_1")
wh1_lat = st.number_input("WH1 Latitude", value=13.02, format="%.6f")
wh1_lon = st.number_input("WH1 Longitude", value=80.22, format="%.6f")

st.subheader("Warehouse 2 (Optional)")
enable_wh2 = st.checkbox("Enable Warehouse 2")

if enable_wh2:
    wh2_name = st.text_input("WH2 Name", "WH_2")
    wh2_lat = st.number_input("WH2 Latitude", value=13.08, format="%.6f")
    wh2_lon = st.number_input("WH2 Longitude", value=80.28, format="%.6f")

# --------------------
# Riders
# --------------------
st.subheader("Rider Inputs")
total_riders = st.number_input("Total Riders", 1, 200, 10)
capacity_per_rider = st.number_input("Max Orders per Rider (Plan A)", 1, 50, 10)

st.subheader("Rider Override (Optional)")
wh1_override = st.number_input("Warehouse 1 Riders (0 = auto)", 0, total_riders, 0)
wh2_override = st.number_input("Warehouse 2 Riders (0 = auto)", 0, total_riders, 0)

# --------------------------------------------------
# GENERATE
# --------------------------------------------------
if st.button("Generate Plans"):
    if uploaded_file is None:
        st.warning("Please upload an Excel file")
        st.stop()

    df = pd.read_excel(uploaded_file)

    base = (
        df.groupby(["Pincode", "Latitude", "Longitude"])["Orders"]
        .sum()
        .reset_index()
        .rename(columns={"Orders": "TotalOrders"})
    )

    # --------------------
    # CLUSTER BY PROXIMITY
    # --------------------
    if enable_wh2:
        base["Dist_WH1"] = base.apply(
            lambda x: euclidean_distance(x.Latitude, x.Longitude, wh1_lat, wh1_lon), axis=1
        )
        base["Dist_WH2"] = base.apply(
            lambda x: euclidean_distance(x.Latitude, x.Longitude, wh2_lat, wh2_lon), axis=1
        )

        wh1_df = base[base["Dist_WH1"] <= base["Dist_WH2"]].copy()
        wh2_df = base[base["Dist_WH1"] > base["Dist_WH2"]].copy()
    else:
        wh1_df = base.copy()
        wh2_df = pd.DataFrame()

    # --------------------
    # RIDER ALLOCATION
    # --------------------
    if enable_wh2:
        if wh1_override > 0 and wh2_override > 0:
            if wh1_override + wh2_override > total_riders:
                st.error("WH1 + WH2 riders exceed Total Riders")
                st.stop()
            wh1_riders = wh1_override
            wh2_riders = wh2_override
        else:
            total_orders = wh1_df["TotalOrders"].sum() + wh2_df["TotalOrders"].sum()
            wh1_share = wh1_df["TotalOrders"].sum() / total_orders if total_orders > 0 else 0.5
            wh1_riders = max(1, round(total_riders * wh1_share))
            wh2_riders = total_riders - wh1_riders
    else:
        wh1_riders = total_riders
        wh2_riders = 0

    # --------------------
    # GLOBAL PLANS
    # --------------------
    global_a = plan_a(base, capacity_per_rider, wh1_lat, wh1_lon, "GLOBAL")
    global_b = plan_b(base, total_riders, wh1_lat, wh1_lon, "GLOBAL")

    # --------------------
    # WAREHOUSE PLANS
    # --------------------
    wh1_a = plan_a(wh1_df, capacity_per_rider, wh1_lat, wh1_lon, wh1_name)
    wh1_b = plan_b(wh1_df, wh1_riders, wh1_lat, wh1_lon, wh1_name)

    st.download_button("â¬‡ Global Plan A", global_a.to_csv(index=False), "Plan_A_Global.csv")
    st.download_button("â¬‡ Global Plan B", global_b.to_csv(index=False), "Plan_B_Global.csv")
    st.download_button("â¬‡ WH1 Plan A", wh1_a.to_csv(index=False), "WH1_Plan_A.csv")
    st.download_button("â¬‡ WH1 Plan B", wh1_b.to_csv(index=False), "WH1_Plan_B.csv")

    if enable_wh2 and not wh2_df.empty:
        wh2_a = plan_a(wh2_df, capacity_per_rider, wh2_lat, wh2_lon, wh2_name)
        wh2_b = plan_b(wh2_df, wh2_riders, wh2_lat, wh2_lon, wh2_name)

        st.download_button("â¬‡ WH2 Plan A", wh2_a.to_csv(index=False), "WH2_Plan_A.csv")
        st.download_button("â¬‡ WH2 Plan B", wh2_b.to_csv(index=False), "WH2_Plan_B.csv")

    # --------------------
    # SUMMARY
    # --------------------
    st.subheader("ðŸš¦ Rider Allocation Summary")

    summary = pd.DataFrame([
        {"Warehouse": wh1_name, "Orders": wh1_df["TotalOrders"].sum(), "Riders": wh1_riders},
        {"Warehouse": wh2_name if enable_wh2 else "-",
         "Orders": wh2_df["TotalOrders"].sum() if enable_wh2 else 0,
         "Riders": wh2_riders}
    ])

    summary["Orders per Rider"] = (summary["Orders"] / summary["Riders"]).round(2)
    st.dataframe(summary)

