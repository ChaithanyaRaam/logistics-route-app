# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import numpy as np
import math
import io
import folium

# --------------------------------------------------
# PAGE CONFIG
# --------------------------------------------------
st.set_page_config(
    page_title="Logistics Route Optimization",
    layout="wide"
)

# --------------------------------------------------
# HELPERS
# --------------------------------------------------
def get_distance(lat1, lon1, lat2, lon2):
    return np.sqrt((lat1 - lat2) ** 2 + (lon1 - lon2) ** 2)

# --------------------------------------------------
# PLAN A â€“ IDEAL CAPACITY BASED
# --------------------------------------------------
def plan_a_capacity_based(
    uploaded_file,
    capacity_per_biker,
    pickup_lat,
    pickup_lon,
    pickup_name
):
    df = pd.read_excel(uploaded_file)

    stops = (
        df.groupby(["Pincode", "Latitude", "Longitude"])["Orders"]
        .sum()
        .reset_index()
        .rename(columns={"Orders": "TotalOrders"})
        .sort_values("Pincode")
        .reset_index(drop=True)
    )

    assigned = []
    biker_id = 1
    used_capacity = 0

    for _, r in stops.iterrows():
        if used_capacity + r["TotalOrders"] > capacity_per_biker:
            biker_id += 1
            used_capacity = 0

        assigned.append({
            "Biker_ID": biker_id,
            "Pincode": r["Pincode"],
            "Latitude": r["Latitude"],
            "Longitude": r["Longitude"],
            "TotalOrders": r["TotalOrders"]
        })
        used_capacity += r["TotalOrders"]

    assigned_df = pd.DataFrame(assigned)

    return build_routes(
        assigned_df,
        pickup_lat,
        pickup_lon,
        pickup_name,
        plan_type="Ideal Capacity Based"
    )

# --------------------------------------------------
# PLAN B â€“ RIDER CONSTRAINED
# --------------------------------------------------
def plan_b_rider_constrained(
    uploaded_file,
    available_bikers,
    pickup_lat,
    pickup_lon,
    pickup_name
):
    df = pd.read_excel(uploaded_file)

    stops = (
        df.groupby(["Pincode", "Latitude", "Longitude"])["Orders"]
        .sum()
        .reset_index()
        .rename(columns={"Orders": "TotalOrders"})
        .sort_values("Pincode")
        .reset_index(drop=True)
    )

    assigned = []
    rider_cycle = list(range(1, available_bikers + 1))
    idx = 0

    for _, r in stops.iterrows():
        assigned.append({
            "Biker_ID": rider_cycle[idx],
            "Pincode": r["Pincode"],
            "Latitude": r["Latitude"],
            "Longitude": r["Longitude"],
            "TotalOrders": r["TotalOrders"]
        })
        idx = (idx + 1) % available_bikers

    assigned_df = pd.DataFrame(assigned)

    final_df = build_routes(
        assigned_df,
        pickup_lat,
        pickup_lon,
        pickup_name,
        plan_type="Rider Constrained"
    )

    load = (
        final_df[final_df["TotalOrders"] > 0]
        .groupby("Biker_ID")["TotalOrders"]
        .sum()
        .reset_index()
        .rename(columns={"TotalOrders": "Total_Load"})
    )

    return final_df.merge(load, on="Biker_ID", how="left")

# --------------------------------------------------
# ROUTE BUILDER (COMMON)
# --------------------------------------------------
def build_routes(df, pickup_lat, pickup_lon, pickup_name, plan_type):
    final_routes = []

    for biker in sorted(df["Biker_ID"].unique()):
        group = df[df["Biker_ID"] == biker].to_dict("records")

        pickup = {
            "Biker_ID": biker,
            "Pincode": pickup_name,
            "Latitude": pickup_lat,
            "Longitude": pickup_lon,
            "TotalOrders": 0
        }

        route = [pickup]
        current = pickup

        while group:
            nearest = min(
                group,
                key=lambda x: get_distance(
                    current["Latitude"], current["Longitude"],
                    x["Latitude"], x["Longitude"]
                )
            )
            route.append(nearest)
            group.remove(nearest)
            current = nearest

        for seq, stop in enumerate(route, start=1):
            stop["Sequence"] = seq
            stop["Plan_Type"] = plan_type
            final_routes.append(stop)

    return pd.DataFrame(final_routes)

# --------------------------------------------------
# STREAMLIT UI
# --------------------------------------------------
st.title("ðŸš´ Logistics Route Optimization â€“ Dual Plan")

uploaded_file = st.file_uploader("Upload Order Excel", type=["xlsx"])

st.subheader("Pickup Location")
pickup_name = st.text_input("Pickup Name", "CHENNAI_WH")
pickup_lat = st.number_input("Latitude", value=13.0827, format="%.6f")
pickup_lon = st.number_input("Longitude", value=80.2707, format="%.6f")

st.subheader("Rider Inputs")
available_bikers = st.number_input("Available Riders", 1, 100, 5)
capacity_per_biker = st.number_input("Max Orders per Rider", 1, 50, 10)

if st.button("Generate Both Plans"):
    if uploaded_file is None:
        st.warning("Please upload an Excel file")
    else:
        plan_a_df = plan_a_capacity_based(
            uploaded_file,
            capacity_per_biker,
            pickup_lat,
            pickup_lon,
            pickup_name
        )

        plan_b_df = plan_b_rider_constrained(
            uploaded_file,
            available_bikers,
            pickup_lat,
            pickup_lon,
            pickup_name
        )

        st.subheader("ðŸ“Š Plan A â€“ Ideal Capacity Based")
        st.dataframe(plan_a_df)

        st.download_button(
            "â¬‡ Download Plan A CSV",
            plan_a_df.to_csv(index=False).encode("utf-8"),
            "Plan_A_Ideal_Capacity_Based.csv",
            "text/csv"
        )

        st.subheader("ðŸ“Š Plan B â€“ Rider Constrained")
        st.dataframe(plan_b_df)

        st.download_button(
            "â¬‡ Download Plan B CSV",
            plan_b_df.to_csv(index=False).encode("utf-8"),
            "Plan_B_Riders_Constrained.csv",
            "text/csv"
        )

