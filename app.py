# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import numpy as np
import math
import io
import folium
from weasyprint import HTML

# --------------------------------------------------
# PAGE CONFIG
# --------------------------------------------------
st.set_page_config(
    page_title="Logistics Route Optimization",
    layout="wide"
)

# --------------------------------------------------
# HELPERS
# --------------------------------------------------
def get_distance(lat1, lon1, lat2, lon2):
    return np.sqrt((lat1 - lat2) ** 2 + (lon1 - lon2) ** 2)

# --------------------------------------------------
# CORE LOGIC
# --------------------------------------------------
def process_logistics(
    uploaded_file,
    available_bikers,
    capacity_per_biker,
    pickup_lat,
    pickup_lon,
    pickup_name
):
    df = pd.read_excel(uploaded_file)

    required_cols = {"Pincode", "Latitude", "Longitude", "Orders"}
    if not required_cols.issubset(df.columns):
        st.error(f"Excel must contain columns: {required_cols}")
        return pd.DataFrame()

    # Aggregate unique stops
    stops = (
        df.groupby(["Pincode", "Latitude", "Longitude"])["Orders"]
        .sum()
        .reset_index()
        .rename(columns={"Orders": "TotalOrders"})
    )

    stops["Area_Name"] = stops["Pincode"].astype(str)
    stops = stops.sort_values("Pincode").reset_index(drop=True)

    # Assign bikers
    assigned = []
    biker_id = 1
    used_capacity = 0

    for _, r in stops.iterrows():
        if used_capacity + r["TotalOrders"] > capacity_per_biker:
            biker_id += 1
            used_capacity = 0

        assigned.append({
            "Biker_ID": biker_id,
            "Pincode": r["Pincode"],
            "Area_Name": r["Area_Name"],
            "Latitude": r["Latitude"],
            "Longitude": r["Longitude"],
            "TotalOrders": r["TotalOrders"]
        })
        used_capacity += r["TotalOrders"]

    assigned_df = pd.DataFrame(assigned)

    # Route optimization
    final_routes = []

    for biker in assigned_df["Biker_ID"].unique():
        group = assigned_df[assigned_df["Biker_ID"] == biker].to_dict("records")

        pickup = {
            "Biker_ID": biker,
            "Pincode": pickup_name,
            "Area_Name": "Pickup Location",
            "Latitude": pickup_lat,
            "Longitude": pickup_lon,
            "TotalOrders": 0
        }

        route = [pickup]
        current = pickup

        while group:
            nearest = min(
                group,
                key=lambda x: get_distance(
                    current["Latitude"], current["Longitude"],
                    x["Latitude"], x["Longitude"]
                )
            )
            route.append(nearest)
            group.remove(nearest)
            current = nearest

        for seq, stop in enumerate(route, start=1):
            stop["Sequence"] = seq
            final_routes.append(stop)

    final_df = pd.DataFrame(final_routes)

    # Summary
    total_orders = stops["TotalOrders"].sum()
    riders_required = math.ceil(total_orders / capacity_per_biker)

    st.markdown("### üìä Delivery Summary")
    st.write(f"**Total Orders:** {total_orders}")
    st.write(f"**Capacity / Rider:** {capacity_per_biker}")
    st.write(f"**Riders Required:** {riders_required}")
    st.write(f"**Riders Available:** {available_bikers}")

    if riders_required > available_bikers:
        st.warning(f"‚ö†Ô∏è Short by {riders_required - available_bikers} riders")
    else:
        st.success("‚úÖ Rider capacity sufficient")

    return final_df

# --------------------------------------------------
# MAP (STREAMLIT ONLY)
# --------------------------------------------------
def render_biker_map(df):
    m = folium.Map(
        location=[df["Latitude"].mean(), df["Longitude"].mean()],
        zoom_start=12
    )

    for _, r in df.iterrows():
        color = "green" if r["TotalOrders"] == 0 else "blue"
        folium.Marker(
            [r["Latitude"], r["Longitude"]],
            popup=f"""
            <b>{r['Pincode']}</b><br>
            Orders: {r['TotalOrders']}<br>
            Seq: {r['Sequence']}
            """,
            icon=folium.Icon(color=color)
        ).add_to(m)

    folium.PolyLine(
        df[["Latitude", "Longitude"]].values.tolist(),
        color="red",
        weight=4
    ).add_to(m)

    return m

# --------------------------------------------------
# PDF (NO MAPS ‚Äì PRINT FRIENDLY)
# --------------------------------------------------
def generate_trip_sheet_pdf(final_df):
    pages = []

    for biker in sorted(final_df["Biker_ID"].unique()):
        biker_df = final_df[final_df["Biker_ID"] == biker].sort_values("Sequence")

        rows_html = ""
        for _, r in biker_df.iterrows():
            rows_html += f"""
            <tr>
                <td>{r['Sequence']}</td>
                <td>{r['Pincode']}</td>
                <td>{r['Area_Name']}</td>
                <td>{r['TotalOrders']}</td>
            </tr>
            """

        pages.append(f"""
        <div style="page-break-after: always;">
            <h2>Biker {biker} ‚Äì Trip Sheet</h2>
            <table border="1" cellspacing="0" cellpadding="6" width="100%">
                <tr>
                    <th>Seq</th>
                    <th>Pincode</th>
                    <th>Area</th>
                    <th>Orders</th>
                </tr>
                {rows_html}
            </table>
        </div>
        """)

    html = f"""
    <html>
    <head>
        <style>
            body {{ font-family: Arial, sans-serif; }}
            h2 {{ margin-bottom: 10px; }}
            table {{ border-collapse: collapse; }}
            th {{ background: #f2f2f2; }}
        </style>
    </head>
    <body>
        <h1>Daily Biker Trip Sheets</h1>
        {''.join(pages)}
    </body>
    </html>
    """

    pdf_buffer = io.BytesIO()
    HTML(string=html).write_pdf(pdf_buffer)
    pdf_buffer.seek(0)

    return pdf_buffer

# --------------------------------------------------
# STREAMLIT UI
# --------------------------------------------------
st.title("üö¥ Logistics Route Optimization")

uploaded_file = st.file_uploader("Upload Order Excel", type=["xlsx"])

st.subheader("Pickup Location")
pickup_name = st.text_input("Pickup Name", "CHENNAI_WH")
pickup_lat = st.number_input("Latitude", value=13.0827, format="%.6f")
pickup_lon = st.number_input("Longitude", value=80.2707, format="%.6f")

st.subheader("Capacity Settings")
available_bikers = st.number_input("Available Bikers", 1, 100, 10)
capacity_per_biker = st.number_input("Orders per Biker", 1, 50, 10)

if st.button("Generate Routes"):
    if uploaded_file is None:
        st.warning("Please upload an Excel file")
    else:
        final_df = process_logistics(
            uploaded_file,
            available_bikers,
            capacity_per_biker,
            pickup_lat,
            pickup_lon,
            pickup_name
        )

        if not final_df.empty:
            st.subheader("üìã Trip Sheet (Table)")
            st.dataframe(final_df)

            # CSV
            st.download_button(
                "‚¨á Download CSV",
                final_df.to_csv(index=False).encode("utf-8"),
                "biker_trip_sheet.csv",
                "text/csv"
            )

            # MAPS (UI only)
            st.subheader("üó∫ Interactive Route Maps")
            for biker in sorted(final_df["Biker_ID"].unique()):
                st.markdown(f"#### Biker {biker}")
                m = render_biker_map(final_df[final_df["Biker_ID"] == biker])
                st.components.v1.html(m._repr_html_(), height=500)

            # PDF
            pdf_buffer = generate_trip_sheet_pdf(final_df)
            st.download_button(
                "‚¨á Download Printable Trip Sheet PDF",
                pdf_buffer,
                "biker_trip_sheets.pdf",
                "application/pdf"
            )

