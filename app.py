# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-Xvp9ny6pf-J5-ByQGZKRlpKEU-48EzD
"""

import streamlit as st
import pandas as pd
import math
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages
from io import BytesIO

# ==================================================
# PAGE CONFIG
# ==================================================
st.set_page_config(page_title="SKC Chennai Logistics Optimizer", layout="wide")
st.title("SKC-Chennai Biker model Route planner")

# ==================================================
# CONFIGURATION & MASTER DATA
# ==================================================
WH_COORDS = {
    "WH1": (12.9300, 80.1400), # Chitlapakkam
    "WH2": (13.0063, 80.2120)  # Guindy
}
PINCODE_MASTER = {
    "600001": (13.09329602, 80.29234733, "North Chennai"),
    "600002": (13.07587854, 80.27184724, "Central Chennai"),
    "600003": (13.08615536, 80.27541704, "North Chennai"),
    "600004": (13.03822395, 80.27128091, "Central Chennai"),
    "600005": (13.06115582, 80.27910272, "Central Chennai"),
    "600006": (13.05816598, 80.25277144, "Central Chennai"),
    "600007": (13.08330279, 80.26371191, "North Chennai"),
    "600008": (13.07072237, 80.26052995, "Central Chennai"),
    "600009": (13.09230677, 80.27978745, "North Chennai"),
    "600010": (13.08533821, 80.24161023, "Central Chennai"),
    "600011": (13.1115722, 80.23642517, "North Chennai"),
    "600012": (13.10072145, 80.25438489, "North Chennai"),
    "600013": (13.11235222, 80.29319999, "North Chennai"),
    "600014": (13.052499, 80.26461449, "Central Chennai"),
    "600015": (13.02147994, 80.22940007, "Velachery / Guindy / Saidapet"),
    "600016": (12.91284343, 80.17941606, "Velachery / Guindy / Saidapet"),
    "600017": (13.04185857, 80.23566124, "Central Chennai"),
    "600018": (13.03968161, 80.25069833, "Central Chennai"),
    "600019": (13.1730176, 80.29978173, "North Chennai"),
    "600020": (13.00861571, 80.26382063, "South / OMR / Tambaram"),
    "600021": (13.11375956, 80.28122798, "North Chennai"),
    "600022": (13.00120492, 80.2270579, "Velachery / Guindy / Saidapet"),
    "600023": (13.09785468, 80.2319479, "Central Chennai"),
    "600024": (13.05095814, 80.22570484, "Central Chennai"),
    "600025": (13.01180002, 80.23554622, "Central Chennai"),
    "600026": (13.0546491, 80.21153926, "West / Inner West"),
    "600027": (12.99369669, 80.17104137, "Velachery / Guindy / Saidapet"),
    "600028": (13.02418865, 80.2657457, "Central Chennai"),
    "600029": (13.07112435, 80.2276888, "West / Inner West"),
    "600030": (13.07852208, 80.22433917, "Central Chennai"),
    "600031": (13.07382434, 80.24273335, "Central Chennai"),
    "600032": (13.00634558, 80.21208726, "Velachery / Guindy / Saidapet"),
    "600033": (13.03665727, 80.22349452, "West / Inner West"),
    "600034": (13.06162757, 80.24200381, "Central Chennai"),
    "600035": (13.02985737, 80.23679016, "Central Chennai"),
    "600036": (12.99346146, 80.23560981, "Velachery / Guindy / Saidapet"),
    "600037": (13.00314698, 80.19439843, "West / Inner West"),
    "600038": (13.09970732, 80.21607728, "North Chennai"),
    "600039": (13.11713793, 80.26141064, "North Chennai"),
    "600040": (13.08791959, 80.20340556, "Central Chennai"),
    "600041": (12.92107178, 80.2465406, "South / OMR / Tambaram"),
    "600042": (12.98731219, 80.21497575, "Velachery / Guindy / Saidapet"),
    "600043": (12.96535263, 80.15826066, "South / OMR / Tambaram"),
    "600044": (12.94443761, 80.08270867, "South / OMR / Tambaram"),
    "600045": (12.89426827, 80.10366229, "South / OMR / Tambaram"),
    "600046": (12.90527285, 80.12248124, "South / OMR / Tambaram"),
    "600047": (12.94009611, 80.11479854, "South / OMR / Tambaram"),
    "600048": (12.81084603, 80.12772838, "South / OMR / Tambaram"),
    "600049": (13.1080933, 80.20458989, "West / Inner West"),
    "600050": (13.07845424, 80.17154103, "West / Inner West"),
    "600051": (13.16442935, 80.24274514, "North Chennai"),
    "600052": (13.18161067, 80.20075271, "Outer West / Peripheral"),
    "600053": (13.12576836, 80.15617958, "West / Inner West"),
    "600054": (13.12153238, 80.08974434, "Outer West / Peripheral"),
    "600055": (13.1520063, 80.06539575, "Outer West / Peripheral"),
    "600056": (13.03248812, 80.10160032, "Outer West / Peripheral"),
    "600057": (13.20823684, 80.3193831, "North Chennai"),
    "600058": (13.08599979, 80.1531458, "West / Inner West"),
    "600059": (12.92470654, 80.12472304, "South / OMR / Tambaram"),
    "600060": (13.15984107, 80.21285943, "North Chennai"),
    "600061": (12.98350623, 80.18568904, "Velachery / Guindy / Saidapet"),
    "600062": (13.14855215, 80.11554808, "Outer West / Peripheral"),
    "600063": (13.14641833, 80.23279686, "South / OMR / Tambaram"),
    "600064": (12.93264682, 80.14546711, "South / OMR / Tambaram"),
    "600065": (13.13664436, 80.07599155, "Outer West / Peripheral"),
    "600066": (13.17287844, 80.14430264, "North Chennai"),
    "600067": (13.24458812, 80.11956125, "Outer West / Peripheral"),
    "600068": (13.16732425, 80.27486313, "North Chennai"),
    "600069": (12.4983356, 79.97398277, "Outer West / Peripheral"),
    "600070": (12.97077623, 80.13057477, "South / OMR / Tambaram"),
    "600071": (13.08290114, 80.13468571, "Outer West / Peripheral"),
    "600072": (13.06843045, 80.03952992, "Outer West / Peripheral"),
    "600073": (12.87473594, 80.16536515, "South / OMR / Tambaram"),
    "600074": (12.97790656, 80.10810227, "Outer West / Peripheral"),
    "600075": (12.97247284, 80.1452778, "South / OMR / Tambaram"),
    "600076": (13.10722147, 80.17469044, "West / Inner West"),
    "600077": (13.09097107, 80.11778444, "Outer West / Peripheral"),
    "600078": (13.03888524, 80.19703562, "West / Inner West"),
    "600079": (13.09873687, 80.27444704, "North Chennai"),
    "600080": (13.11995567, 80.18563394, "West / Inner West"),
    "600081": (13.1416658, 80.27579586, "North Chennai"),
    "600082": (13.11271678, 80.22637171, "North Chennai"),
    "600083": (13.03479859, 80.21221648, "West / Inner West"),
    "600084": (13.0767389, 80.25536237, "Central Chennai"),
    "600085": (13.01153278, 80.24443489, "Central Chennai"),
    "600086": (13.01882901, 80.25013371, "Central Chennai"),
    "600087": (13.04286066, 80.17383656, "West / Inner West"),
    "600088": (12.97756594, 80.21120853, "Velachery / Guindy / Saidapet"),
    "600089": (13.03111379, 80.17885348, "West / Inner West"),
    "600090": (13.00035027, 80.26501762, "South / OMR / Tambaram"),
    "600091": (12.95940286, 80.19959318, "Velachery / Guindy / Saidapet"),
    "600092": (13.05479426, 80.19262737, "West / Inner West"),
    "600093": (13.04982278, 80.19958382, "West / Inner West"),
    "600094": (13.0587169, 80.22123519, "Central Chennai"),
    "600095": (13.00159395, 80.07333575, "Outer West / Peripheral"),
    "600096": (12.92217332, 80.21549887, "South / OMR / Tambaram"),
    "600097": (13.02105769, 80.1931161, "South / OMR / Tambaram"),
    "600098": (13.01657599, 80.20718349, "West / Inner West"),
    "600099": (13.12735674, 80.20347764, "West / Inner West"),
    "600100": (12.94342554, 80.18769461, "South / OMR / Tambaram"),
    "600101": (13.09346695, 80.19369249, "West / Inner West"),
    "600102": (13.08901357, 80.22177351, "Central Chennai"),
    "600103": (13.21852413, 80.28708594, "North Chennai / Peripheral"),
    "600104": (13.07738623, 80.28344719, "North Chennai"),
    "600105": (13.06556481, 80.26477927, "South / OMR / Tambaram"),
    "600106": (13.07272018, 80.2120151, "West / Inner West"),
    "600107": (13.06642121, 80.19938448, "West / Inner West"),
    "600108": (13.09004952, 80.28378675, "North Chennai"),
    "600109": (13.085291, 80.28188795, "North Chennai"),
    "600110": (13.13040427, 80.22737043, "North Chennai"),
    "600111": (13.05998516, 80.17606474, "West / Inner West"),
    "600112": (13.09375497, 80.26446011, "North Chennai"),
    "600113": (12.97360185, 80.238453, "Velachery / Guindy / Saidapet"),
    "600114": (12.98256562, 80.19529625, "Velachery / Guindy / Saidapet"),
    "600115": (12.98791928, 80.2438125, "South / OMR / Tambaram"),
    "600116": (13.03950621, 80.14712513, "West / Inner West"),
    "600117": (12.95986297, 80.17695456, "South / OMR / Tambaram"),
    "600118": (13.13085292, 80.25301868, "North Chennai"),
    "600119": (12.84670995, 80.2205652, "South / OMR / Tambaram"),
}

WH1_ZONES = ["South / OMR / Tambaram", "Outer West / Peripheral"]
WH2_ZONES = ["Velachery / Guindy / Saidapet", "Central Chennai", "West / Inner West", "North Chennai"]


def route_as_ladder(df, start_lat, start_lon):
    if df.empty: return df
    lat_span = df['Latitude'].max() - df['Latitude'].min()
    lon_span = df['Longitude'].max() - df['Longitude'].min()
    if lat_span > lon_span:
        is_forward = df['Latitude'].mean() > start_lat
        return df.sort_values(by='Latitude', ascending=is_forward).reset_index(drop=True)
    else:
        is_forward = df['Longitude'].mean() > start_lon
        return df.sort_values(by='Longitude', ascending=is_forward).reset_index(drop=True)

def get_optimized_sequence(df, start_lat, start_lon, zones):
    remaining = df.copy()
    full_sequence = []
    curr_lat, curr_lon = start_lat, start_lon
    for zone in zones:
        zdf = remaining[remaining.Zone == zone]
        if zdf.empty: continue
        routed = route_as_ladder(zdf, curr_lat, curr_lon)
        full_sequence.append(routed)
        last = routed.iloc[-1]
        curr_lat, curr_lon = last.Latitude, last.Longitude
        remaining = remaining[~remaining.Pincode.isin(routed.Pincode)]
    return pd.concat(full_sequence) if full_sequence else pd.DataFrame()

# ==================================================
# VISUALIZATION LOGIC
# ==================================================
def generate_route_pdf(df):
    buf = BytesIO()
    with PdfPages(buf) as pdf:
        bikers = df.sort_values(['Warehouse', 'Biker_ID'])[['Warehouse', 'Biker_ID']].drop_duplicates()
        for _, row in bikers.iterrows():
            wh_name, biker_id = row['Warehouse'], row['Biker_ID']
            wh_lat, wh_lon = WH_COORDS[wh_name]
            biker_df = df[(df['Warehouse'] == wh_name) & (df['Biker_ID'] == biker_id)]

            lats = [wh_lat] + biker_df['Latitude'].tolist() + [wh_lat]
            lons = [wh_lon] + biker_df['Longitude'].tolist() + [wh_lon]
            pincodes = ["WH"] + biker_df['Pincode'].astype(str).tolist() + ["WH"]

            fig, ax = plt.subplots(figsize=(8, 6))
            ax.plot(lons, lats, marker='o', linestyle='-', color='#1f77b4', markersize=6, linewidth=1.5)
            for i, txt in enumerate(pincodes):
                ax.annotate(f"{i}. {txt}", (lons[i], lats[i]), fontsize=8, xytext=(3,3), textcoords="offset points")

            ax.plot(wh_lon, wh_lat, marker='s', color='red', markersize=10, label='Warehouse')
            ax.set_title(f"Biker {biker_id} Route ({wh_name})\nOrders: {biker_df['Orders'].sum()}")
            ax.grid(True, alpha=0.3)
            plt.tight_layout()
            pdf.savefig(fig)
            plt.close(fig)
    buf.seek(0)
    return buf

# ==================================================
# MAIN APP FLOW
# ==================================================
if "results" not in st.session_state:
    st.session_state.results = {}

st.sidebar.header("Operational Constraints")
max_cap_input = st.sidebar.number_input("Order Limit (Plan A)", 1, 100, 15)
staff_count = st.sidebar.number_input("Internal Staff Count", 1, 100, 5)
uploaded_file = st.sidebar.file_uploader("Upload Delivery Data", type=["csv", "xlsx"])

if st.button("Generate Dispatch Sheets"):
    if uploaded_file:
        raw = pd.read_excel(uploaded_file) if uploaded_file.name.endswith("xlsx") else pd.read_csv(uploaded_file)
        raw.columns = [c.strip() for c in raw.columns]
        raw['Pincode'] = raw['Pincode'].astype(str).str.strip()

        master_df = pd.DataFrame([{"Pincode": k, "Latitude": v[0], "Longitude": v[1], "Zone": v[2]} for k, v in PINCODE_MASTER.items()])
        merged = raw.groupby('Pincode', as_index=False)['Orders'].sum().merge(master_df, on="Pincode", how="inner")

        # Split Warehouses
        w1_data = merged[merged.Zone.isin(WH1_ZONES)]
        w2_data = merged[~merged.Pincode.isin(w1_data.Pincode)]

        # Optimize Sequences
        seq_w1 = get_optimized_sequence(w1_data, WH_COORDS["WH1"][0], WH_COORDS["WH1"][1], WH1_ZONES)
        seq_w2 = get_optimized_sequence(w2_data, WH_COORDS["WH2"][0], WH_COORDS["WH2"][1], WH2_ZONES)

        # Plan A (Capacity)
        def plan_a_logic(df, wh, cap, start_id):
            res, biker, load = [], start_id, 0
            for _, r in df.iterrows():
                if load + r.Orders > cap: biker += 1; load = 0
                res.append({**r.to_dict(), "Biker_ID": biker, "Warehouse": wh})
                load += r.Orders
            return pd.DataFrame(res), biker

        pa1, last_id = plan_a_logic(seq_w1, "WH1", max_cap_input, 1)
        pa2, total_needed = plan_a_logic(seq_w2, "WH2", max_cap_input, last_id + 1)
        plan_a = pd.concat([pa1, pa2])

        # Plan B (Staff Split)
        w1_b_count = max(1, round(staff_count * len(w1_data) / len(merged)))
        w2_b_count = max(1, staff_count - w1_b_count)
        pb1 = pd.concat([c.assign(Biker_ID=i+1, Warehouse="WH1") for i, c in enumerate(np.array_split(seq_w1, w1_b_count))]) if not seq_w1.empty else pd.DataFrame()
        pb2 = pd.concat([c.assign(Biker_ID=i+1+w1_b_count, Warehouse="WH2") for i, c in enumerate(np.array_split(seq_w2, w2_b_count))]) if not seq_w2.empty else pd.DataFrame()
        plan_b = pd.concat([pb1, pb2])

        # Generate Visualizations
        pdf_a = generate_route_pdf(plan_a)
        pdf_b = generate_route_pdf(plan_b)

        st.session_state.results = {
            "A": plan_a, "B": plan_b, "pdf_a": pdf_a, "pdf_b": pdf_b,
            "needed": total_needed, "staff": staff_count
        }
    else:
        st.error("Please upload a data file.")

if st.session_state.results:
    res = st.session_state.results
    extra = max(0, res["needed"] - res["staff"])

    st.markdown("Staffing Summary")
    c1, c2, c3 = st.columns(3)
    c1.metric("Bikers Needed (Plan A)", res["needed"])
    c2.metric("Total Internal Staff", res["staff"])
    c3.metric("Freelancers Required", extra, delta=extra if extra > 0 else None, delta_color="inverse")

    st.write("Download Dispatch Documents")
    colA, colB = st.columns(2)
    with colA:
        st.markdown("**Plan A (Capacity-Based)**")
        st.download_button("Download Plan A CSV", res["A"].to_csv(index=False), "Plan_A_Dispatch.csv")
        st.download_button("Download Plan A Route PDF", res["pdf_a"], "Plan_A_Route_Maps.pdf")
    with colB:
        st.markdown("**Plan B (Staff-Based)**")
        st.download_button("Download Plan B CSV", res["B"].to_csv(index=False), "Plan_B_Dispatch.csv")
        st.download_button("Download Plan B Route PDF", res["pdf_b"], "Plan_B_Route_Maps.pdf")

    st.write("---")
    st.write("### üó∫Ô∏è Route Preview (Plan A)")
    # Show the first few maps as preview
    preview_bikers = res["A"].Biker_ID.unique()[:3]
    for bid in preview_bikers:
        b_data = res["A"][res["A"].Biker_ID == bid]
        wh = b_data.iloc[0].Warehouse
        wh_lat, wh_lon = WH_COORDS[wh]
        fig, ax = plt.subplots(figsize=(5, 3))
        ax.plot([wh_lon]+b_data.Longitude.tolist()+[wh_lon], [wh_lat]+b_data.Latitude.tolist()+[wh_lat], marker='o')
        ax.set_title(f"Biker {bid} Preview")
        st.pyplot(fig)

